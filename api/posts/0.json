{"title":"","slug":"day9","date":"2022-04-09","updated":"2022-04-09","comments":true,"path":"api/posts/0.json","excerpt":null,"cover":"https://cdn.nlark.com/yuque/0/2020/png/500370/1596676687838-a406f714-246d-4d85-a6da-53d4fd72e0ce.png#height=337&id=dzqQ6&margin=%5Bobject%20Object%5D&name=image.png&originHeight=620&originWidth=1227&originalType=binary&ratio=1&size=51043&status=done&style=none&width=667","covers":["https://cdn.nlark.com/yuque/0/2020/png/500370/1596676687838-a406f714-246d-4d85-a6da-53d4fd72e0ce.png#height=337&id=dzqQ6&margin=%5Bobject%20Object%5D&name=image.png&originHeight=620&originWidth=1227&originalType=binary&ratio=1&size=51043&status=done&style=none&width=667","https://cdn.nlark.com/yuque/0/2020/png/500370/1596678534363-3f73a9e9-128d-4038-bbe9-a9ab4d4eba94.png#height=204&id=WQ6uw&margin=%5Bobject%20Object%5D&name=image.png&originHeight=300&originWidth=884&originalType=binary&ratio=1&size=36727&status=done&style=none&width=602","https://cdn.nlark.com/yuque/0/2020/png/500370/1596683069531-03a470f7-a81c-4478-bfce-a385f831bd99.png#height=364&id=QetT5&margin=%5Bobject%20Object%5D&name=image.png&originHeight=475&originWidth=800&originalType=binary&ratio=1&size=77872&status=done&style=none&width=613","https://cdn.nlark.com/yuque/0/2020/png/500370/1596684291379-1afa5934-9100-48cb-88e7-1c02a8285b78.png#height=314&id=lLOb0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=475&originWidth=758&originalType=binary&ratio=1&size=156490&status=done&style=none&width=501","https://cdn.nlark.com/yuque/0/2020/png/500370/1596697535797-434ed1ea-9a46-4443-be53-8a3b69d93e1a.png#height=249&id=YnSTG&margin=%5Bobject%20Object%5D&name=image.png&originHeight=497&originWidth=1100&originalType=binary&ratio=1&size=36433&status=done&style=none&width=550","https://cdn.nlark.com/yuque/0/2020/png/500370/1596699223409-0c1e35d3-e7c0-4bcf-9ddf-3fc1baf4fa08.png#height=212&id=H3Gwn&margin=%5Bobject%20Object%5D&name=image.png&originHeight=424&originWidth=1008&originalType=binary&ratio=1&size=42472&status=done&style=none&width=504","https://cdn.nlark.com/yuque/0/2020/png/500370/1596700741233-c7e0c5d4-6130-4e30-8cad-d69ed1e8c004.png#height=352&id=jMIP4&margin=%5Bobject%20Object%5D&name=image.png&originHeight=475&originWidth=810&originalType=binary&ratio=1&size=175199&status=done&style=none&width=601","https://cdn.nlark.com/yuque/0/2020/png/500370/1596701492921-8e684663-9ecb-49d7-b565-6b88247b50bf.png#height=398&id=AqF5b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=562&originWidth=601&originalType=binary&ratio=1&size=49781&status=done&style=none&width=426"],"content":"<h1 id=\"\"><a href=\"#\"class=\"headerlink\"title=\"\"></a><img src=\"https://cdn.nlark.com/yuque/0/2020/png/500370/1596676687838-a406f714-246d-4d85-a6da-53d4fd72e0ce.png#height=337&id=dzqQ6&margin=%5Bobject%20Object%5D&name=image.png&originHeight=620&originWidth=1227&originalType=binary&ratio=1&size=51043&status=done&style=none&width=667\" alt=\"image.png\"></h1><h1 id=\"AS\"><a href=\"#AS\" class=\"headerlink\" title=\"AS\"></a>AS</h1><ul>\n<li><p>AS：autonomous system 自治系统</p>\n</li>\n<li><p>不同 AS 通过 AS 号区分，AS 号的范围是 1-65525，其中 64512-65535 是私有 AS 号。IANA 负责 AS 号的划分</p>\n</li>\n<li><p>中国电信 163AS 号：4134</p>\n</li>\n<li><p>中国电信 CN2AS 号：4809</p>\n</li>\n<li><p>中国网通 AS 号：9929</p>\n<h1 id=\"IGP\"><a href=\"#IGP\" class=\"headerlink\" title=\"IGP\"></a>IGP</h1></li>\n<li><p>内部网关协议</p>\n</li>\n<li><p>执行拓扑发现</p>\n</li>\n<li><p>尽力完成快速收敛</p>\n</li>\n<li><p>需要周期性的更新来确保路由信息选择的精确性</p>\n</li>\n<li><p>受同一个管理机构的控制</p>\n</li>\n<li><p>采取了共同的路由选择策略</p>\n</li>\n<li><p>提供了优先的策略控制能力</p>\n<h1 id=\"EGP\"><a href=\"#EGP\" class=\"headerlink\" title=\"EGP\"></a>EGP</h1></li>\n<li><p>外部网关协议</p>\n</li>\n<li><p>早期有一个协议的名称就叫做 EGP，后来被 BGP 取代</p>\n<h1 id=\"BGP\"><a href=\"#BGP\" class=\"headerlink\" title=\"BGP\"></a>BGP</h1></li>\n<li><p>边界网关路由协议（路径矢量）</p>\n</li>\n<li><p>主要作用是在 AS 之间传递路由信息</p>\n</li>\n<li><p>目前主要版本是有四个：v1，v2，v3，v4</p>\n</li>\n<li><p>为什么使用 BGP</p>\n<ul>\n<li>大量路由需要承载，IGP 只能容纳千条，BGP 可以容纳上万条</li>\n<li>支持 vpn</li>\n<li>策略能力强，可以实现路由决策与数据控制</li>\n</ul>\n</li>\n<li><p>BGP 使用 TCP 为传输层协议，TCP 端口号为 179</p>\n</li>\n<li><p>BGP 路由器之间建立 TCP 连接，这些路由器称为 BGP 对等体，也叫 BGP 邻居：EBGP，IBGP</p>\n</li>\n<li><p>对等体之间交换整个 bgp 路由表</p>\n</li>\n<li><p>BGP 路由器只发送增量更新或者触发更新（不会周期更新）</p>\n</li>\n<li><p>具有丰富的路径属性</p>\n</li>\n<li><p>BGP 通告成千上万的路由，可采用 TCP 滑动窗口的机制，停止并等待确认前，可以发送 65576 个字节</p>\n<h1 id=\"拓扑\"><a href=\"# 拓扑\" class=\"headerlink\" title=\"拓扑\"></a>拓扑</h1><p>                    <img src=\"https://cdn.nlark.com/yuque/0/2020/png/500370/1596678534363-3f73a9e9-128d-4038-bbe9-a9ab4d4eba94.png#height=204&id=WQ6uw&margin=%5Bobject%20Object%5D&name=image.png&originHeight=300&originWidth=884&originalType=binary&ratio=1&size=36727&status=done&style=none&width=602\" alt=\"image.png\"></p>\n<h3 id=\"基础配置\"><a href=\"# 基础配置\" class=\"headerlink\" title=\"基础配置\"></a>基础配置</h3><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">R1#sh run | sec int</span><br><span class=\"line\">interface Loopback0</span><br><span class=\"line\"> ip address 1.1.1.1 255.255.255.0</span><br><span class=\"line\">interface Ethernet0/0</span><br><span class=\"line\"> ip address 192.168.12.1 255.255.255.0</span><br><span class=\"line\">=========================================</span><br><span class=\"line\">R2#sh run | sec int</span><br><span class=\"line\">mmi polling-interval 60</span><br><span class=\"line\">interface Loopback0</span><br><span class=\"line\"> ip address 2.2.2.2 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\">interface Ethernet0/0</span><br><span class=\"line\"> ip address 192.168.12.2 255.255.255.0</span><br><span class=\"line\">interface Ethernet0/1</span><br><span class=\"line\"> ip address 192.168.23.2 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\">interface Ethernet0/2</span><br><span class=\"line\"> ip address 192.168.24.2 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\">=========================================</span><br><span class=\"line\">R3#sh run | sec int</span><br><span class=\"line\">interface Loopback0</span><br><span class=\"line\"> ip address 3.3.3.3 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\">interface Ethernet0/0</span><br><span class=\"line\"> ip address 192.168.23.3 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\">interface Ethernet0/1</span><br><span class=\"line\"> ip address 192.168.35.3 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\">=========================================</span><br><span class=\"line\">R4#sh run | sec int</span><br><span class=\"line\">interface Loopback0</span><br><span class=\"line\"> ip address 4.4.4.4 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\">interface Ethernet0/0</span><br><span class=\"line\"> ip address 192.168.24.4 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\">interface Ethernet0/1</span><br><span class=\"line\"> ip address 192.168.45.4 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\">=========================================</span><br><span class=\"line\">R5#sh run | sec int</span><br><span class=\"line\">interface Loopback0</span><br><span class=\"line\"> ip address 5.5.5.5 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\">interface Ethernet0/0</span><br><span class=\"line\"> ip address 192.168.35.5 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\">interface Ethernet0/1</span><br><span class=\"line\"> ip address 192.168.45.5 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\">interface Ethernet0/2</span><br><span class=\"line\"> ip address 192.168.56.5 255.255.255.0</span><br><span class=\"line\">=========================================</span><br><span class=\"line\">R6#sh run | sec int</span><br><span class=\"line\">interface Loopback0</span><br><span class=\"line\"> ip address 6.6.6.6 255.255.255.0</span><br><span class=\"line\">interface Ethernet0/0</span><br><span class=\"line\"> ip address 192.168.56.6 255.255.255.0</span><br></pre></td></tr></table></figure>\n<h3 id=\"IBGP 配置\"><a href=\"#IBGP 配置\" class=\"headerlink\" title=\"IBGP 配置\"></a>IBGP 配置</h3><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">R2#sh run | sec bgp</span><br><span class=\"line\">router bgp 200</span><br><span class=\"line\"> bgp log-neighbor-changes\t\t\t\t\t\t\t\t\t\t\t\t\t# 开启邻居辩护日志显示，默认存在</span><br><span class=\"line\"> neighbor 5.5.5.5 remote-as 200</span><br><span class=\"line\"> neighbor 5.5.5.5 update-source Loopback0</span><br><span class=\"line\"> neighbor 5.5.5.5 next-hop-self</span><br><span class=\"line\"></span><br><span class=\"line\">R5#sh run | sec bgp</span><br><span class=\"line\">router bgp 200</span><br><span class=\"line\"> bgp log-neighbor-changes</span><br><span class=\"line\"> neighbor 2.2.2.2 remote-as 200</span><br><span class=\"line\"> neighbor 2.2.2.2 update-source Loopback0</span><br><span class=\"line\"> neighbor 2.2.2.2 next-hop-self</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"EBGP 配置\"><a href=\"#EBGP 配置\" class=\"headerlink\" title=\"EBGP 配置\"></a>EBGP 配置</h3><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">R1#sh run | sec bgp</span><br><span class=\"line\">router bgp 100</span><br><span class=\"line\"> bgp log-neighbor-changes</span><br><span class=\"line\"> network 1.1.1.0 mask 255.255.255.0</span><br><span class=\"line\"> neighbor 2.2.2.2 remote-as 200</span><br><span class=\"line\"> neighbor 2.2.2.2 ebgp-multihop 255</span><br><span class=\"line\"> neighbor 2.2.2.2 update-source Loopback0</span><br><span class=\"line\"> ip route 2.2.2.2 255.255.255.255 192.168.12.2</span><br><span class=\"line\">R2#sh run | sec bgp</span><br><span class=\"line\">router bgp 200</span><br><span class=\"line\"> bgp log-neighbor-changes</span><br><span class=\"line\"> neighbor 1.1.1.1 remote-as 100</span><br><span class=\"line\"> neighbor 1.1.1.1 ebgp-multihop 255</span><br><span class=\"line\"> neighbor 1.1.1.1 update-source Loopback0</span><br><span class=\"line\"> ip route 1.1.1.1 255.255.255.255 192.168.12.1</span><br><span class=\"line\"> =========================================</span><br><span class=\"line\">R5#sh run | sec bgp</span><br><span class=\"line\">router bgp 200</span><br><span class=\"line\"> bgp log-neighbor-changes</span><br><span class=\"line\"> neighbor 6.6.6.6 remote-as 300</span><br><span class=\"line\"> neighbor 6.6.6.6 ebgp-multihop 255</span><br><span class=\"line\"> neighbor 6.6.6.6 update-source Loopback0</span><br><span class=\"line\"> ip route 6.6.6.6 255.255.255.255 192.168.56.6</span><br><span class=\"line\">R6#sh run | sec bgp</span><br><span class=\"line\">router bgp 300</span><br><span class=\"line\"> bgp log-neighbor-changes</span><br><span class=\"line\"> network 6.6.6.0 mask 255.255.255.0</span><br><span class=\"line\"> neighbor 5.5.5.5 remote-as 200</span><br><span class=\"line\"> neighbor 5.5.5.5 ebgp-multihop 255</span><br><span class=\"line\"> neighbor 5.5.5.5 update-source Loopback0</span><br><span class=\"line\"> ip route 5.5.5.5 255.255.255.255 192.168.56.5</span><br></pre></td></tr></table></figure>\n<h1 id=\"BGP 邻居\"><a href=\"#BGP 邻居\" class=\"headerlink\" title=\"BGP 邻居\"></a>BGP 邻居</h1></li>\n<li><p>运行 BGP 的路由器叫做 BGP Speaker</p>\n</li>\n<li><p>BGP 对等体也叫 BGP 邻居，建立基于 TCP</p>\n</li>\n<li><p>IBGP</p>\n<ul>\n<li>邻居和自己处于同一个 AS 中</li>\n<li>通过 IBGP 学习到的路由管理距离为 200</li>\n<li>从 IBGP 学到的路由不会再传递给其他的 IBGP 邻居</li>\n<li>如果开启了 BGP 同步，那么没有在 IGP 学习到的路由，BGP 也不会用</li>\n<li>IBGP 邻居传递路由默认不会修改下一条地址为发出的那台路由器</li>\n</ul>\n</li>\n<li><p>EBGP</p>\n<ul>\n<li>邻居处于不同的 AS 中</li>\n<li>通过 EBGP 学习到的路由管理距离为 20</li>\n<li>EBGP 邻居为了安全烤炉，传递的数据包中 TTL 值默认为 1</li>\n<li>EBGP 邻居传递路由默认会修改下一条地址为发出的那台路由器 <h1 id=\"BGP 消息类型\"><a href=\"#BGP 消息类型\" class=\"headerlink\" title=\"BGP 消息类型\"></a>BGP 消息类型</h1><h3 id=\"BGP-packet\"><a href=\"#BGP-packet\" class=\"headerlink\" title=\"BGP packet\"></a>BGP packet</h3>            <img src=\"https://cdn.nlark.com/yuque/0/2020/png/500370/1596683069531-03a470f7-a81c-4478-bfce-a385f831bd99.png#height=364&id=QetT5&margin=%5Bobject%20Object%5D&name=image.png&originHeight=475&originWidth=800&originalType=binary&ratio=1&size=77872&status=done&style=none&width=613\" alt=\"image.png\"><h3 id=\"五种报文\"><a href=\"# 五种报文\" class=\"headerlink\" title=\"五种报文\"></a> 五种报文</h3><table>\n<thead>\n<tr>\n<th>报文名称</th>\n<th>作用</th>\n<th>发包时间</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>OPEN</td>\n<td>协商 BGP 邻居的各项参数，建立邻居关系</td>\n<td>通过 TCP 建立 BGP 连接，发送 OPEN</td>\n</tr>\n<tr>\n<td>UPDATE</td>\n<td>进行路由信息的交换</td>\n<td>连接建立之后，有路由需要发送或者是路由变化，发送 update 通告对端的路由信息</td>\n</tr>\n<tr>\n<td>NOTIFICATION</td>\n<td>报告错误，终止邻居关系</td>\n<td>当 BGP 运行中发生错误的时候，需要发送 NOTIFICATION 报文通告 BGP 对端</td>\n</tr>\n<tr>\n<td>KEEPALIVE</td>\n<td>维持邻居关系</td>\n<td>定时发送 KEEPALIVE 保持 BGP 邻居关系的有效性</td>\n</tr>\n<tr>\n<td>Route-refresh</td>\n<td>为保证网络稳定，触发更新路由的机制</td>\n<td>当路由策略发生变化，触发请求邻居重新通告路由</td>\n</tr>\n</tbody></table>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"BGP 有限状态机\"><a href=\"#BGP 有限状态机\" class=\"headerlink\" title=\"BGP 有限状态机\"></a>BGP 有限状态机</h3><table>\n<thead>\n<tr>\n<th>状态名称</th>\n<th>发什么包</th>\n<th>功能</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Idle</td>\n<td>尝试建立 TCP</td>\n<td>开始准备 tcp 连接，监听远程 peer 启动 tcp 连接，启用 bgp 时需要较高的资源</td>\n</tr>\n<tr>\n<td>Connect</td>\n<td>发送 tcp 包</td>\n<td>正则进行 tcp 连接，如果连接时报会进入 Active 状态，反复尝试连接</td>\n</tr>\n<tr>\n<td>Active</td>\n<td>发送 tcp 包</td>\n<td>继续进行 tcp 连接</td>\n</tr>\n<tr>\n<td>OpenSent</td>\n<td>发送 OPEN 包</td>\n<td>tcp 连接已经完成建立，开始发送 OPEN 包，协商各种参数以及邻居的建立</td>\n</tr>\n<tr>\n<td>OpenConfirm</td>\n<td>发送 KEEPALIVE 包</td>\n<td>协商成功之后，进入邻居保活</td>\n</tr>\n<tr>\n<td>Established</td>\n<td>发送 UPDATE</td>\n<td>收到对方的 KEEPALIVE 包，性能一致，开始更新双方的路由信息</td>\n</tr>\n</tbody></table>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2020/png/500370/1596684291379-1afa5934-9100-48cb-88e7-1c02a8285b78.png#height=314&id=lLOb0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=475&originWidth=758&originalType=binary&ratio=1&size=156490&status=done&style=none&width=501\" alt=\"image.png\"></p>\n<h1 id=\"BGP 维护\"><a href=\"#BGP 维护\" class=\"headerlink\" title=\"BGP 维护\"></a>BGP 维护</h1><ul>\n<li><p>硬重置（不推荐使用）</p>\n<ul>\n<li>断开所有的 tcp 连接以及邻居的状态</li>\n<li>会导致断网</li>\n<li>clear ip bgp *</li>\n</ul>\n</li>\n<li><p>软重置（推荐使用）</p>\n<ul>\n<li>不拆除并重建 TCP、BGP 连接，而是仅仅触发更新的操作以便让新的路由策略生效</li>\n<li>软重置可以针对出站、入站，也可以同时针对出站和入站</li>\n<li>clear ip bgp * soft [in | out]<h1 id=\"BGP 表\"><a href=\"#BGP 表\" class=\"headerlink\" title=\"BGP 表\"></a>BGP 表 </h1><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">R2#sh ip bgp summary </span><br><span class=\"line\">BGP router identifier 2.2.2.2, local AS number 200</span><br><span class=\"line\">BGP table version is 10, main routing table version 10</span><br><span class=\"line\">2 network entries using 288 bytes of memory</span><br><span class=\"line\">2 path entries using 168 bytes of memory</span><br><span class=\"line\">2/2 BGP path/bestpath attribute entries using 320 bytes of memory</span><br><span class=\"line\">2 BGP AS-PATH entries using 48 bytes of memory</span><br><span class=\"line\">0 BGP route-map cache entries using 0 bytes of memory</span><br><span class=\"line\">0 BGP filter-list cache entries using 0 bytes of memory</span><br><span class=\"line\">BGP using 824 total bytes of memory</span><br><span class=\"line\">BGP activity 5/3 prefixes, 5/3 paths, scan interval 60 secs</span><br><span class=\"line\">Neighbor        V           AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd</span><br><span class=\"line\">1.1.1.1         4          100      24      23       10    0    0 00:07:32        1</span><br><span class=\"line\">5.5.5.5         4          200     274     280       10    0    0 03:59:34        1</span><br><span class=\"line\">R2#</span><br><span class=\"line\">Neighbor：邻居</span><br><span class=\"line\">AS：邻居的 AS 号</span><br><span class=\"line\">MsgRcvd：收到的消息数</span><br><span class=\"line\"> 发送的消息数</span><br><span class=\"line\">TblVer：最后一次邻居表版本号</span><br><span class=\"line\">InQ：入站等到被处理的消息数</span><br><span class=\"line\">OutQ：出站等待被处理的消息数</span><br><span class=\"line\">Up/Down：显示的是建立邻居的时间，如果显示为 never 的化代表邻居没有建立成功</span><br><span class=\"line\">State：当邻居成功建立进入 Established 状态的时候，这里显示的是路由的数目，否则就是 active 状态</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">R2#sh ip bgp</span><br><span class=\"line\">BGP table version is 10, local router ID is 2.2.2.2</span><br><span class=\"line\">Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, </span><br><span class=\"line\">              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, </span><br><span class=\"line\">              x best-external, a additional-path, c RIB-compressed, </span><br><span class=\"line\">              t secondary path, </span><br><span class=\"line\">Origin codes: i - IGP, e - EGP, ? - incomplete</span><br><span class=\"line\">RPKI validation codes: V valid, I invalid, N Not found</span><br><span class=\"line\"></span><br><span class=\"line\">     Network          Next Hop            Metric LocPrf Weight Path</span><br><span class=\"line\"> *&gt;   1.1.1.0/24       1.1.1.1                  0             0 100 i</span><br><span class=\"line\"> *&gt;i  6.6.6.0/24       5.5.5.5                  0    100      0 300 i</span><br><span class=\"line\"> 第一栏可能取值 </span><br><span class=\"line\"> \t\t*：可用的路由（不一定是最优）</span><br><span class=\"line\">    s：被抑制的路由条目，比如过了路由汇总抑制了明细</span><br><span class=\"line\">    d：被惩罚的路由，在惩罚期结束前是不允许通告</span><br><span class=\"line\">    h：被惩罚的路由，有历史信息，但可能没有最佳路由</span><br><span class=\"line\">    r：路由没有被装进 RIB 表，例如由于 AD 等原因导致的</span><br><span class=\"line\">    S：标识过期的路由</span><br><span class=\"line\"> 第二栏可能取值 </span><br><span class=\"line\">\t\t&gt;：最佳路由</span><br><span class=\"line\"> 第三栏可能取值</span><br><span class=\"line\">    从 EBGP 邻居获取则为空</span><br><span class=\"line\">    从 IBGP 邻居获取则为 i</span><br><span class=\"line\">Network：网段</span><br><span class=\"line\">Next Hop：吓一跳</span><br><span class=\"line\">Metric：度量值</span><br><span class=\"line\">LocPrf：本地优先级，从 ebgp 邻居学校的没有本地优先级</span><br><span class=\"line\">Weight：权重</span><br><span class=\"line\">Path：路径</span><br></pre></td></tr></table></figure>\n<h1 id=\"水平分割原则\"><a href=\"# 水平分割原则\" class=\"headerlink\" title=\"水平分割原则\"></a>水平分割原则</h1></li>\n</ul>\n</li>\n<li><p>BGP 是通过 AS_PATH 实现放环的，但是 AS_PATH 仅仅在离开 AS 后才会被更改，在 AS 内部 IBGP 邻居没有防环能力，为了防止环路出现，BGP 路由器不会将从 IBGP 邻居学习过来的路由通告给自己其他 IBGP 邻居</p>\n</li>\n<li><p>由于水平分割原则，在 AS 内部，需要保证全互联</p>\n</li>\n</ul>\n<p>                        <img src=\"https://cdn.nlark.com/yuque/0/2020/png/500370/1596697535797-434ed1ea-9a46-4443-be53-8a3b69d93e1a.png#height=249&id=YnSTG&margin=%5Bobject%20Object%5D&name=image.png&originHeight=497&originWidth=1100&originalType=binary&ratio=1&size=36433&status=done&style=none&width=550\" alt=\"image.png\"></p>\n<h1 id=\"BGP 路由黑洞解决\"><a href=\"#BGP 路由黑洞解决\" class=\"headerlink\" title=\"BGP 路由黑洞解决\"></a>BGP 路由黑洞解决 </h1><h3 id=\"重发步 bgp 路由进入 igp\"><a href=\"# 重发步 bgp 路由进入 igp\" class=\"headerlink\" title=\"重发步 bgp 路由进入 igp\"></a> 重发步 bgp 路由进入 igp</h3><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在 R2 和 R5 上进行重发步特定的路由条目 </span><br><span class=\"line\">R2</span><br><span class=\"line\">route-map b-o permit 10</span><br><span class=\"line\"> match ip address 1</span><br><span class=\"line\">!</span><br><span class=\"line\">access-list 1 permit 1.1.1.0 0.0.0.255</span><br><span class=\"line\">!</span><br><span class=\"line\">router ospf 1</span><br><span class=\"line\"> redistribute bgp 200 subnets route-map b-o</span><br><span class=\"line\">R5</span><br><span class=\"line\">route-map b-o permit 10</span><br><span class=\"line\"> match ip address 1</span><br><span class=\"line\">!</span><br><span class=\"line\">access-list 1 permit 6.6.6.0 0.0.0.255</span><br><span class=\"line\">!</span><br><span class=\"line\">router ospf 1</span><br><span class=\"line\"> redistribute bgp 200 subnets route-map b-o</span><br><span class=\"line\"> ===============================================================</span><br><span class=\"line\"> 在 R3 上检查路由表，发现多了两条 OE2 的路由条目</span><br><span class=\"line\"> R3#sh ip route</span><br><span class=\"line\">      1.0.0.0/24 is subnetted, 1 subnets</span><br><span class=\"line\">O E2     1.1.1.0 [110/1] via 192.168.23.2, 00:06:41, Ethernet0/0</span><br><span class=\"line\">      2.0.0.0/32 is subnetted, 1 subnets</span><br><span class=\"line\">O        2.2.2.2 [110/11] via 192.168.23.2, 00:11:15, Ethernet0/0</span><br><span class=\"line\">      3.0.0.0/8 is variably subnetted, 2 subnets, 2 masks</span><br><span class=\"line\">C        3.3.3.0/24 is directly connected, Loopback0</span><br><span class=\"line\">L        3.3.3.3/32 is directly connected, Loopback0</span><br><span class=\"line\">      4.0.0.0/32 is subnetted, 1 subnets</span><br><span class=\"line\">O        4.4.4.4 [110/21] via 192.168.35.5, 00:11:15, Ethernet0/1</span><br><span class=\"line\">                 [110/21] via 192.168.23.2, 00:11:15, Ethernet0/0</span><br><span class=\"line\">      5.0.0.0/32 is subnetted, 1 subnets</span><br><span class=\"line\">O        5.5.5.5 [110/11] via 192.168.35.5, 00:11:15, Ethernet0/1</span><br><span class=\"line\">      6.0.0.0/24 is subnetted, 1 subnets</span><br><span class=\"line\">O E2     6.6.6.0 [110/1] via 192.168.35.5, 00:05:36, Ethernet0/1</span><br><span class=\"line\">      192.168.23.0/24 is variably subnetted, 2 subnets, 2 masks</span><br><span class=\"line\">C        192.168.23.0/24 is directly connected, Ethernet0/0</span><br><span class=\"line\">L        192.168.23.3/32 is directly connected, Ethernet0/0</span><br><span class=\"line\">O     192.168.24.0/24 [110/20] via 192.168.23.2, 00:11:15, Ethernet0/0</span><br><span class=\"line\">      192.168.35.0/24 is variably subnetted, 2 subnets, 2 masks</span><br><span class=\"line\">C        192.168.35.0/24 is directly connected, Ethernet0/1</span><br><span class=\"line\">L        192.168.35.3/32 is directly connected, Ethernet0/1</span><br><span class=\"line\">O     192.168.45.0/24 [110/20] via 192.168.35.5, 00:11:15, Ethernet0/1</span><br><span class=\"line\"> ===============================================================</span><br><span class=\"line\"> 在 R1 上 ping6.6.6.6 检查连通性</span><br><span class=\"line\">R1#ping 6.6.6.6 source 1.1.1.1</span><br><span class=\"line\">Type escape sequence to abort.</span><br><span class=\"line\">Sending 5, 100-byte ICMP Echos to 6.6.6.6, timeout is 2 seconds:</span><br><span class=\"line\">Packet sent with a source address of 1.1.1.1 </span><br><span class=\"line\">!!!!!</span><br><span class=\"line\">Success rate is 100 percent (5/5), round-trip min/avg/max = 1/1/1 ms</span><br><span class=\"line\">R1#</span><br></pre></td></tr></table></figure>\n<h3 id=\"全互联\"><a href=\"# 全互联\" class=\"headerlink\" title=\"全互联\"></a>全互联 </h3><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> 以 R3 的配置为例，AS200 里每一台路由器（R2/R4/R5）都需要和其他路由器建立邻居 </span><br><span class=\"line\">R3#show run | sec bgp</span><br><span class=\"line\">router bgp 200</span><br><span class=\"line\"> bgp log-neighbor-changes</span><br><span class=\"line\"> neighbor eagle peer-group</span><br><span class=\"line\"> neighbor eagle remote-as 200</span><br><span class=\"line\"> neighbor eagle update-source Loopback0</span><br><span class=\"line\"> neighbor eagle next-hop-self</span><br><span class=\"line\"> neighbor 2.2.2.2 peer-group eagle</span><br><span class=\"line\"> neighbor 4.4.4.4 peer-group eagle</span><br><span class=\"line\"> neighbor 5.5.5.5 peer-group eagle</span><br><span class=\"line\"> 在 R3 上检查路由表，发现成功学习 6.6.6.0 的路由条目，解决了路由黑洞</span><br><span class=\"line\"> R3#sh ip route bgp</span><br><span class=\"line\">      1.0.0.0/24 is subnetted, 1 subnets</span><br><span class=\"line\">B        1.1.1.0 [200/0] via 2.2.2.2, 00:04:18</span><br><span class=\"line\">      6.0.0.0/24 is subnetted, 1 subnets</span><br><span class=\"line\">B        6.6.6.0 [200/0] via 5.5.5.5, 00:01:58</span><br><span class=\"line\"> 在 R1 上 ping6.6.6.6 检查连通性</span><br><span class=\"line\">R1#ping 6.6.6.6 source 1.1.1.1</span><br><span class=\"line\">Type escape sequence to abort.</span><br><span class=\"line\">Sending 5, 100-byte ICMP Echos to 6.6.6.6, timeout is 2 seconds:</span><br><span class=\"line\">Packet sent with a source address of 1.1.1.1 </span><br><span class=\"line\">!!!!!</span><br><span class=\"line\">Success rate is 100 percent (5/5), round-trip min/avg/max = 1/1/1 ms</span><br></pre></td></tr></table></figure>\n<h3 id=\"路由反射器\"><a href=\"# 路由反射器\" class=\"headerlink\" title=\"路由反射器\"></a>路由反射器</h3><ul>\n<li>指定一台路由器为路由反射器</li>\n<li>其他所有路由器和路由反射器建立 IBGP 邻居</li>\n<li>当其他路由器有路由更新时会将更细腻的路由发给路由反射器，路由反射器会将消息全部告诉给其他 IBGP 邻居</li>\n</ul>\n<p>                    <img src=\"https://cdn.nlark.com/yuque/0/2020/png/500370/1596699223409-0c1e35d3-e7c0-4bcf-9ddf-3fc1baf4fa08.png#height=212&id=H3Gwn&margin=%5Bobject%20Object%5D&name=image.png&originHeight=424&originWidth=1008&originalType=binary&ratio=1&size=42472&status=done&style=none&width=504\" alt=\"image.png\"></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">选举 R3 作为路由反射器，R2/R4/R5 都和 R3 建立 IBGP 理距</span><br><span class=\"line\">R2#sh run | sec bgp</span><br><span class=\"line\">router bgp 200</span><br><span class=\"line\"> bgp log-neighbor-changes\t\t\t\t\t\t\t\t\t\t\t# 开启邻居变化时日志显示，默认存在</span><br><span class=\"line\"> neighbor 3.3.3.3 remote-as 200\t\t\t\t\t\t\t\t# 指定邻居 AS 号</span><br><span class=\"line\"> neighbor 3.3.3.3 update-source Loopback0\t\t\t# 指定以环回接口进行建立邻居</span><br><span class=\"line\"> neighbor 3.3.3.3 next-hop-self\t\t\t\t\t\t\t\t# 指定跟新条目时下一条为自己</span><br><span class=\"line\"> ===============================================================</span><br><span class=\"line\">R3#sh run | sec bgp</span><br><span class=\"line\">router bgp 200</span><br><span class=\"line\"> bgp log-neighbor-changes</span><br><span class=\"line\"> neighbor eagle peer-group</span><br><span class=\"line\"> neighbor eagle remote-as 200</span><br><span class=\"line\"> neighbor eagle update-source Loopback0</span><br><span class=\"line\"> neighbor eagle route-reflector-client</span><br><span class=\"line\"> neighbor eagle next-hop-self</span><br><span class=\"line\"> neighbor 2.2.2.2 peer-group eagle</span><br><span class=\"line\"> neighbor 4.4.4.4 peer-group eagle</span><br><span class=\"line\"> neighbor 5.5.5.5 peer-group eagle</span><br><span class=\"line\">===============================================================</span><br><span class=\"line\">R4#sh run | sec bgp</span><br><span class=\"line\">router bgp 200</span><br><span class=\"line\"> bgp log-neighbor-changes</span><br><span class=\"line\"> neighbor 3.3.3.3 remote-as 200</span><br><span class=\"line\"> neighbor 3.3.3.3 update-source Loopback0</span><br><span class=\"line\"> neighbor 3.3.3.3 next-hop-self</span><br><span class=\"line\"> =============================================================== </span><br><span class=\"line\"> R5#sh run | sec bgp</span><br><span class=\"line\">router bgp 200</span><br><span class=\"line\"> bgp log-neighbor-changes</span><br><span class=\"line\"> neighbor 3.3.3.3 remote-as 200</span><br><span class=\"line\"> neighbor 3.3.3.3 update-source Loopback0</span><br><span class=\"line\"> neighbor 3.3.3.3 next-hop-self</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h1 id=\"BGP 常见属性\"><a href=\"#BGP 常见属性\" class=\"headerlink\" title=\"BGP 常见属性\"></a>BGP 常见属性</h1><ul>\n<li>公认属性（Well-Known）<ul>\n<li>公认强制属性 Well-Known mandatory</li>\n<li>公认自由决定属性 Well-Known discretionary</li>\n</ul>\n</li>\n<li>可选属性（Optional）<ul>\n<li>可选传递的 Optional transitive</li>\n<li>可选非传递的 Optional non-transitive</li>\n</ul>\n</li>\n</ul>\n<p>                <img src=\"https://cdn.nlark.com/yuque/0/2020/png/500370/1596700741233-c7e0c5d4-6130-4e30-8cad-d69ed1e8c004.png#height=352&id=jMIP4&margin=%5Bobject%20Object%5D&name=image.png&originHeight=475&originWidth=810&originalType=binary&ratio=1&size=175199&status=done&style=none&width=601\" alt=\"image.png\"></p>\n<h3 id=\"权重（weight）\"><a href=\"# 权重（weight）\" class=\"headerlink\" title=\"权重（weight）\"></a>权重（weight）</h3><ul>\n<li><p>在路由器本地配置，只提供本地路由策略，不会传播给任何 bgp 邻居</p>\n</li>\n<li><p>范围：0-65535，越大越优先</p>\n</li>\n<li><p>路由器本地事发的路径默认权重为 32768，从其他 bgp 邻居学习到的为 0</p>\n<h3 id=\"本地优先级（local-preference）\"><a href=\"# 本地优先级（local-preference）\" class=\"headerlink\" title=\"本地优先级（local preference）\"></a>本地优先级（local preference）</h3></li>\n<li><p>公认自由决定属性</p>\n</li>\n<li><p>告诉 AS 中的路由器，哪条路径是离开 AS 的首选路径</p>\n</li>\n<li><p>LP 越高优先级越高</p>\n</li>\n<li><p>只发送给 IBGP 邻居，不传递给 EBGP 邻居</p>\n</li>\n<li><p>默认本地优先级为 100</p>\n<h3 id=\"拓扑 -1\"><a href=\"# 拓扑 -1\" class=\"headerlink\" title=\"拓扑\"></a>拓扑</h3><p>                                <img src=\"https://cdn.nlark.com/yuque/0/2020/png/500370/1596701492921-8e684663-9ecb-49d7-b565-6b88247b50bf.png#height=398&id=AqF5b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=562&originWidth=601&originalType=binary&ratio=1&size=49781&status=done&style=none&width=426\" alt=\"image.png\"></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">基础配置 </span><br><span class=\"line\">R1#sh run | sec int</span><br><span class=\"line\">interface Loopback0</span><br><span class=\"line\"> ip address 1.1.1.1 255.255.255.0</span><br><span class=\"line\">interface Ethernet0/0</span><br><span class=\"line\"> ip address 192.168.12.1 255.255.255.0</span><br><span class=\"line\">interface Ethernet0/1</span><br><span class=\"line\"> ip address 192.168.13.1 255.255.255.0</span><br><span class=\"line\">R2#sh run | sec int</span><br><span class=\"line\">interface Loopback0</span><br><span class=\"line\"> ip address 2.2.2.2 255.255.255.0</span><br><span class=\"line\">interface Ethernet0/0</span><br><span class=\"line\"> ip address 192.168.12.2 255.255.255.0</span><br><span class=\"line\">interface Ethernet0/1</span><br><span class=\"line\"> ip address 192.168.24.2 255.255.255.0</span><br><span class=\"line\">R3#sh run | sec int</span><br><span class=\"line\">interface Loopback0</span><br><span class=\"line\"> ip address 3.3.3.3 255.255.255.0</span><br><span class=\"line\">interface Ethernet0/0</span><br><span class=\"line\"> ip address 192.168.13.3 255.255.255.0</span><br><span class=\"line\">interface Ethernet0/1</span><br><span class=\"line\"> ip address 192.168.35.3 255.255.255.0</span><br><span class=\"line\">R4#sh run | sec int</span><br><span class=\"line\">interface Loopback0</span><br><span class=\"line\"> ip address 4.4.4.4 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\">interface Ethernet0/0</span><br><span class=\"line\"> ip address 192.168.34.4 255.255.255.0</span><br><span class=\"line\">interface Ethernet0/1</span><br><span class=\"line\"> ip address 192.168.45.4 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\">interface Ethernet0/2</span><br><span class=\"line\"> ip address 192.168.46.4 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\">R5#show running-config | section int </span><br><span class=\"line\">interface Loopback0</span><br><span class=\"line\"> ip address 5.5.5.5 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\">interface Ethernet0/0</span><br><span class=\"line\"> ip address 192.168.35.5 255.255.255.0</span><br><span class=\"line\">interface Ethernet0/1</span><br><span class=\"line\"> ip address 192.168.45.5 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\">interface Ethernet0/2</span><br><span class=\"line\"> ip address 192.168.56.5 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\">R6#sh run | sec int</span><br><span class=\"line\">interface Loopback0</span><br><span class=\"line\"> ip address 6.6.6.6 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\">interface Ethernet0/0</span><br><span class=\"line\"> ip address 192.168.46.6 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\">interface Ethernet0/1</span><br><span class=\"line\"> ip address 192.168.56.6 255.255.255.0</span><br><span class=\"line\"> ip ospf 1 area 0</span><br><span class=\"line\"> =============================================================== </span><br><span class=\"line\"> 配置 BGP</span><br><span class=\"line\"> R1#sh run | sec route</span><br><span class=\"line\">router bgp 100</span><br><span class=\"line\"> bgp log-neighbor-changes</span><br><span class=\"line\"> network 1.1.1.0 mask 255.255.255.0</span><br><span class=\"line\"> neighbor 2.2.2.2 remote-as 200</span><br><span class=\"line\"> neighbor 2.2.2.2 ebgp-multihop 255</span><br><span class=\"line\"> neighbor 2.2.2.2 update-source Loopback0</span><br><span class=\"line\"> neighbor 3.3.3.3 remote-as 300</span><br><span class=\"line\"> neighbor 3.3.3.3 ebgp-multihop 255</span><br><span class=\"line\"> neighbor 3.3.3.3 update-source Loopback0</span><br><span class=\"line\">ip route 2.2.2.2 255.255.255.255 192.168.12.2</span><br><span class=\"line\">ip route 3.3.3.3 255.255.255.255 192.168.13.3</span><br><span class=\"line\">R2#sh run | sec route</span><br><span class=\"line\">router bgp 200</span><br><span class=\"line\"> bgp log-neighbor-changes</span><br><span class=\"line\"> neighbor 1.1.1.1 remote-as 100</span><br><span class=\"line\"> neighbor 1.1.1.1 ebgp-multihop 255</span><br><span class=\"line\"> neighbor 1.1.1.1 update-source Loopback0</span><br><span class=\"line\"> neighbor 4.4.4.4 remote-as 400</span><br><span class=\"line\"> neighbor 4.4.4.4 ebgp-multihop 255</span><br><span class=\"line\"> neighbor 4.4.4.4 update-source Loopback0</span><br><span class=\"line\">ip route 1.1.1.1 255.255.255.255 192.168.12.1</span><br><span class=\"line\">ip route 4.4.4.4 255.255.255.255 192.168.24.4</span><br><span class=\"line\">R3#sh run | sec route</span><br><span class=\"line\">router bgp 300</span><br><span class=\"line\"> bgp log-neighbor-changes</span><br><span class=\"line\"> neighbor 1.1.1.1 remote-as 100</span><br><span class=\"line\"> neighbor 1.1.1.1 ebgp-multihop 255</span><br><span class=\"line\"> neighbor 1.1.1.1 update-source Loopback0</span><br><span class=\"line\"> neighbor 5.5.5.5 remote-as 400</span><br><span class=\"line\"> neighbor 5.5.5.5 ebgp-multihop 255</span><br><span class=\"line\"> neighbor 5.5.5.5 update-source Loopback0</span><br><span class=\"line\">ip route 1.1.1.1 255.255.255.255 192.168.13.1</span><br><span class=\"line\">ip route 5.5.5.5 255.255.255.255 192.168.35.5</span><br><span class=\"line\">R4#sh run | sec route</span><br><span class=\"line\">router ospf 1</span><br><span class=\"line\">router bgp 400</span><br><span class=\"line\"> bgp log-neighbor-changes</span><br><span class=\"line\"> neighbor 2.2.2.2 remote-as 200</span><br><span class=\"line\"> neighbor 2.2.2.2 ebgp-multihop 255</span><br><span class=\"line\"> neighbor 2.2.2.2 update-source Loopback0</span><br><span class=\"line\"> neighbor 6.6.6.6 remote-as 400</span><br><span class=\"line\"> neighbor 6.6.6.6 update-source Loopback0</span><br><span class=\"line\"> neighbor 6.6.6.6 next-hop-self</span><br><span class=\"line\">ip route 2.2.2.2 255.255.255.255 192.168.24.2</span><br><span class=\"line\">R5#sh run | sec route</span><br><span class=\"line\">router ospf 1</span><br><span class=\"line\">router bgp 400</span><br><span class=\"line\"> bgp log-neighbor-changes</span><br><span class=\"line\"> network 5.5.5.0</span><br><span class=\"line\"> neighbor 3.3.3.3 remote-as 300</span><br><span class=\"line\"> neighbor 3.3.3.3 ebgp-multihop 255</span><br><span class=\"line\"> neighbor 3.3.3.3 update-source Loopback0</span><br><span class=\"line\"> neighbor 6.6.6.6 remote-as 400</span><br><span class=\"line\"> neighbor 6.6.6.6 update-source Loopback0</span><br><span class=\"line\"> neighbor 6.6.6.6 next-hop-self</span><br><span class=\"line\">ip route 3.3.3.3 255.255.255.255 192.168.35.3</span><br><span class=\"line\">router bgp 400</span><br><span class=\"line\"> bgp log-neighbor-changes</span><br><span class=\"line\"> network 6.6.6.0 mask 255.255.255.0</span><br><span class=\"line\"> neighbor 4.4.4.4 remote-as 400</span><br><span class=\"line\"> neighbor 4.4.4.4 update-source Loopback0</span><br><span class=\"line\"> neighbor 4.4.4.4 route-reflector-client</span><br><span class=\"line\"> neighbor 4.4.4.4 next-hop-self</span><br><span class=\"line\"> neighbor 5.5.5.5 remote-as 400</span><br><span class=\"line\"> neighbor 5.5.5.5 update-source Loopback0</span><br><span class=\"line\"> neighbor 5.5.5.5 route-reflector-client</span><br><span class=\"line\"> neighbor 5.5.5.5 next-hop-self</span><br><span class=\"line\"> =============================================================== </span><br><span class=\"line\"> 在本地修改 weight 值</span><br><span class=\"line\">R6#sh run</span><br><span class=\"line\">access-list 1 permit 1.1.1.0</span><br><span class=\"line\">router bgp 400</span><br><span class=\"line\"> neighbor 5.5.5.5 weight 10\t\t\t\t# 这种方式会影响到所有来自邻居 5.5.5.5 的路由条目的权重</span><br><span class=\"line\">router bgp 400</span><br><span class=\"line\">route-map R6 permit 10</span><br><span class=\"line\"> match ip address 1</span><br><span class=\"line\"> set weight 100\t\t\t\t\t\t\t\t\t\t# 这种方式可以针对具体的路由条目设置权重</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n","url":"/posts/0/","min2read":22,"word4post":"4.4k","prev_post":null,"next_post":{"title":"Hello World","url":"/posts/16107/"},"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"\" href = \"#\"><span class=\"toc-number\">1.</span> <span class=\"toc-text\"></span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"AS\" href = \"#\"><span class=\"toc-number\">2.</span> <span class=\"toc-text\">AS</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"IGP\" href = \"#\"><span class=\"toc-number\">3.</span> <span class=\"toc-text\">IGP</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"EGP\" href = \"#\"><span class=\"toc-number\">4.</span> <span class=\"toc-text\">EGP</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"BGP\" href = \"#\"><span class=\"toc-number\">5.</span> <span class=\"toc-text\">BGP</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"拓扑\" href = \"#\"><span class=\"toc-number\">6.</span> <span class=\"toc-text\">拓扑</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" data-id=\"基础配置\" href = \"#\"><span class=\"toc-number\">6.0.1.</span> <span class=\"toc-text\">基础配置</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" data-id=\"IBGP 配置\" href = \"#\"><span class=\"toc-number\">6.0.2.</span> <span class=\"toc-text\">IBGP 配置</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" data-id=\"EBGP 配置\" href = \"#\"><span class=\"toc-number\">6.0.3.</span> <span class=\"toc-text\">EBGP 配置</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"BGP 邻居\" href = \"#\"><span class=\"toc-number\">7.</span> <span class=\"toc-text\">BGP 邻居</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"BGP 消息类型\" href = \"#\"><span class=\"toc-number\">8.</span> <span class=\"toc-text\">BGP 消息类型</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" data-id=\"BGP-packet\" href = \"#\"><span class=\"toc-number\">8.0.1.</span> <span class=\"toc-text\">BGP packet</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" data-id=\"五种报文\" href = \"#\"><span class=\"toc-number\">8.0.2.</span> <span class=\"toc-text\"> 五种报文</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" data-id=\"BGP 有限状态机\" href = \"#\"><span class=\"toc-number\">8.0.3.</span> <span class=\"toc-text\">BGP 有限状态机</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"BGP 维护\" href = \"#\"><span class=\"toc-number\">9.</span> <span class=\"toc-text\">BGP 维护</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"BGP 表\" href = \"#\"><span class=\"toc-number\">10.</span> <span class=\"toc-text\">BGP 表 </span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"水平分割原则\" href = \"#\"><span class=\"toc-number\">11.</span> <span class=\"toc-text\">水平分割原则</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"BGP 路由黑洞解决\" href = \"#\"><span class=\"toc-number\">12.</span> <span class=\"toc-text\">BGP 路由黑洞解决 </span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" data-id=\"重发步 bgp 路由进入 igp\" href = \"#\"><span class=\"toc-number\">12.0.1.</span> <span class=\"toc-text\"> 重发步 bgp 路由进入 igp</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" data-id=\"全互联\" href = \"#\"><span class=\"toc-number\">12.0.2.</span> <span class=\"toc-text\">全互联 </span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" data-id=\"路由反射器\" href = \"#\"><span class=\"toc-number\">12.0.3.</span> <span class=\"toc-text\">路由反射器</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"BGP 常见属性\" href = \"#\"><span class=\"toc-number\">13.</span> <span class=\"toc-text\">BGP 常见属性</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" data-id=\"权重（weight）\" href = \"#\"><span class=\"toc-number\">13.0.1.</span> <span class=\"toc-text\">权重（weight）</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" data-id=\"本地优先级（local-preference）\" href = \"#\"><span class=\"toc-number\">13.0.2.</span> <span class=\"toc-text\">本地优先级（local preference）</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" data-id=\"拓扑 -1\" href = \"#\"><span class=\"toc-number\">13.0.3.</span> <span class=\"toc-text\">拓扑</span></a></li></ol></li></ol></li></ol>","categories":[],"tags":[]}